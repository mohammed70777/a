<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .progress-bar {
            transition: width 0.3s ease;
        }
        .hidden { display: none; }
        .alert-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        canvas { max-width: 100%; height: auto; }
        .jumbotron { position: relative; }
    </style>
    <title>String Art Generator Pro</title>
</head>
<body>
    <div class="container">
        <div class="jumbotron">
            <div class="alert-container" id="alertContainer"></div>
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <a href="https://github.com/halfmonty/StringArtGenerator" class="btn btn-sm btn-outline-secondary">
                    <i class="fab fa-github"></i> View on GitHub
                </a>
                <button class="btn btn-primary" onclick="onHasSteps()">Load Existing</button>
            </div>

            <h1 class="display-4">String Art Generator</h1>
            
            <div class="progress hidden mt-3" id="progressBar">
                <div class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%"></div>
            </div>

            <div class="variables-section mt-4">
                <h5>Generator Settings:</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="numberOfPins">Number of Pins (36-500)</label>
                            <input type="number" class="form-control" id="numberOfPins" min="36" max="500">
                            <small class="text-danger hidden" id="pinsError">Must be between 36-500</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="numberOfLines">Number of Lines</label>
                            <input type="number" class="form-control" id="numberOfLines" min="100" max="10000">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="lineWeight">Line Weight</label>
                            <input type="number" class="form-control" id="lineWeight" min="1" max="50">
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <label class="btn btn-primary btn-lg">
                    <i class="fas fa-image"></i> Select Image 
                    <input type="file" id="fileInput" hidden>
                </label>
            </div>
        </div>

        <!-- Visualization Sections -->
        <div class="row">
            <div class="col">
                <!-- Steps 1-3 same as before -->
                <!-- ShowPins section with save button -->
                <div id="showPins" class="hidden mt-4">
                    <button class="btn btn-success mb-3" onclick="saveResult()">
                        <i class="fas fa-download"></i> Save as PNG
                    </button>
                    <!-- Rest of showPins content -->
                </div>
            </div>
        </div>
    </div>

<script>
// Improved Configuration
const CONFIG = {
    IMG_SIZE: 500,
    MAX_LINES: 4000,
    N_PINS: 288,
    LINE_WEIGHT: 20,
    MIN_DISTANCE: 20,
    SCALE: 2
};

// Web Worker Management
const worker = new Worker('worker.js');

// Initialization
let imgElement = document.getElementById("imageSrc");
let inputElement = document.getElementById("fileInput");
inputElement.addEventListener("change", handleImageUpload);

function handleImageUpload(e) {
    if(!validateInputs()) return;
    const file = e.target.files[0];
    if(!file.type.startsWith('image/')) {
        showAlert('Please upload a valid image file', 'danger');
        return;
    }
    imgElement.src = URL.createObjectURL(file);
}

function validateInputs() {
    const pins = parseInt(numberOfPins.value);
    if(pins < 36 || pins > 500) {
        showAlert('Number of pins must be between 36-500', 'danger');
        return false;
    }
    return true;
}

// Progress Handling
function updateProgress(percentage) {
    const progressBar = document.querySelector('.progress-bar');
    progressBar.style.width = `${percentage}%`;
    progressBar.textContent = `${Math.round(percentage)}%`;
    progressBar.parentElement.classList.remove('hidden');
}

// Web Worker Communication
worker.onmessage = function(e) {
    switch(e.data.task) {
        case 'pinsDone':
            handlePinsCalculation(e.data.result);
            break;
        case 'linesProgress':
            updateProgress(e.data.progress);
            break;
        case 'processingError':
            showAlert(e.data.error, 'danger');
            break;
    }
};

function handlePinsCalculation(pins) {
    pin_coords = pins;
    showStep(2);
    worker.postMessage({
        task: 'precalculateLines',
        pins: pin_coords,
        config: CONFIG
    });
}

// Enhanced Drawing Functions
function drawOptimized() {
    const canvas = document.getElementById('canvasOutput2');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Batch draw operations
    const BATCH_SIZE = 100;
    let drawn = 0;
    
    function drawBatch() {
        const limit = Math.min(drawn + BATCH_SIZE, line_sequence.length-1);
        for(; drawn < limit; drawn++) {
            const start = pin_coords[line_sequence[drawn]];
            const end = pin_coords[line_sequence[drawn+1]];
            drawLine(ctx, start, end);
        }
        
        if(drawn < line_sequence.length-1) {
            requestAnimationFrame(drawBatch);
        }
    }
    
    drawBatch();
}

function drawLine(ctx, start, end) {
    ctx.beginPath();
    ctx.moveTo(start[0] * CONFIG.SCALE, start[1] * CONFIG.SCALE);
    ctx.lineTo(end[0] * CONFIG.SCALE, end[1] * CONFIG.SCALE);
    ctx.strokeStyle = 'rgba(0,0,0,0.1)';
    ctx.lineWidth = 0.5;
    ctx.stroke();
}

// Save Functionality
function saveResult() {
    const canvas = document.getElementById('canvasOutput2');
    const link = document.createElement('a');
    link.download = `string-art-${Date.now()}.png`;
    link.href = canvas.toDataURL();
    link.click();
}

// Error Handling
function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">&times;</button>
    `;
    
    document.getElementById('alertContainer').appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Event Listeners
document.getElementById('numberOfPins').addEventListener('input', function(e) {
    const value = parseInt(e.target.value);
    if(value >= 36 && value <= 500) {
        CONFIG.N_PINS = value;
        document.getElementById('pinsError').classList.add('hidden');
    } else {
        document.getElementById('pinsError').classList.remove('hidden');
    }
});

// Rest of the original functionality remains similar but uses CONFIG
// ... (Original code adapted to use the new CONFIG object and worker)

function onOpenCvReady() {
    document.getElementById('status').textContent = 'Ready to generate!';
    document.getElementById('numberOfPins').value = CONFIG.N_PINS;
    document.getElementById('numberOfLines').value = CONFIG.MAX_LINES;
    document.getElementById('lineWeight').value = CONFIG.LINE_WEIGHT;
}
</script>

<!-- worker.js content as separate file -->
<script>
// Save this as worker.js
self.onmessage = function(e) {
    const { task, data } = e.data;
    
    try {
        switch(task) {
            case 'calculatePins':
                const pins = [];
                const center = data.center;
                const radius = data.radius;
                
                for(let i = 0; i < data.N_PINS; i++) {
                    const angle = 2 * Math.PI * i / data.N_PINS;
                    pins.push([
                        Math.floor(center + radius * Math.cos(angle)),
                        Math.floor(center + radius * Math.sin(angle))
                    ]);
                }
                self.postMessage({ task: 'pinsDone', result: pins });
                break;
                
            case 'precalculateLines':
                // Line precalculation logic
                break;
                
            // Add other cases as needed
        }
    } catch (error) {
        self.postMessage({ 
            task: 'processingError',
            error: error.message 
        });
    }
};
</script>

<!-- باقي السكريبتات الأصلية -->
<script async src="opencv.js" onload="onOpenCvReady();"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</body>
</html>
