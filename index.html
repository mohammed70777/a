<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>String Art Generator Pro</title>
    
    <!-- التبعيات -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        .progress-bar { transition: width 0.3s ease; }
        .hidden { display: none; }
        canvas { border: 1px solid #ddd; margin: 10px; }
        .jumbotron { padding: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="jumbotron">
            <div id="alertContainer"></div>
            
            <div class="d-flex justify-content-between mb-4">
                <a href="https://github.com/halfmonty/StringArtGenerator" class="btn btn-sm btn-outline-secondary">
                    <i class="fab fa-github"></i> GitHub
                </a>
                <button class="btn btn-primary" onclick="onHasSteps()">Load Existing</button>
            </div>

            <h1 class="display-4">String Art Generator</h1>
            
            <div class="progress hidden my-3">
                <div class="progress-bar progress-bar-striped" style="width: 0%"></div>
            </div>

            <div class="my-4">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Number of Pins (36-500)</label>
                            <input type="number" id="numberOfPins" class="form-control" value="288" min="36" max="500">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Number of Lines</label>
                            <input type="number" id="numberOfLines" class="form-control" value="4000">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Line Weight</label>
                            <input type="number" id="lineWeight" class="form-control" value="20">
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <label class="btn btn-primary btn-lg">
                    <i class="fas fa-image"></i> Select Image 
                    <input type="file" id="fileInput" hidden>
                </label>
            </div>
        </div>

        <!-- مراحل المعالجة -->
        <div id="processingSteps">
            <div id="step1" class="hidden">
                <h5>Original Image</h5>
                <img id="imageSrc" class="img-fluid">
            </div>
            
            <div id="step2" class="hidden">
                <h5>Processed Image</h5>
                <canvas id="canvasOutput" class="img-fluid"></canvas>
            </div>
            
            <div id="step3" class="hidden">
                <h5>Result</h5>
                <canvas id="canvasOutput2" class="img-fluid"></canvas>
                <button class="btn btn-success mt-3" onclick="saveResult()">
                    <i class="fas fa-download"></i> Save PNG
                </button>
            </div>
        </div>
    </div>

<!-- الكود الأساسي -->
<script>
// التهيئة
const STATE = {
    IMG_SIZE: 500,
    pins: [],
    lines: [],
    currentStep: 0
};

// معالجة الصورة
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file.type.startsWith('image/')) {
        showAlert('Please select an image file', 'danger');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('imageSrc').src = e.target.result;
        document.getElementById('step1').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
});

// حفظ النتيجة
function saveResult() {
    const canvas = document.getElementById('canvasOutput2');
    const link = document.createElement('a');
    link.download = `string-art-${Date.now()}.png`;
    link.href = canvas.toDataURL();
    link.click();
}

// إدارة التقدم
function updateProgress(percent) {
    const bar = document.querySelector('.progress-bar');
    bar.style.width = percent + '%';
    bar.textContent = Math.round(percent) + '%';
}

// معالجة الأخطاء
function showAlert(msg, type) {
    const alert = `<div class="alert alert-${type} alert-dismissible fade show">
        ${msg}
        <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>`;
    document.getElementById('alertContainer').innerHTML = alert;
}

// Web Worker
const workerCode = `  
self.onmessage = function(e) {
    const { task, data } = e.data;
    try {
        switch(task) {
            case 'calculatePins':
                const pins = [];
                for(let i=0; i<data.total; i++) {
                    const angle = (Math.PI * 2 * i)/data.total;
                    pins.push([
                        Math.floor(data.center + data.radius * Math.cos(angle)),
                        Math.floor(data.center + data.radius * Math.sin(angle))
                    ]);
                }
                self.postMessage({ task: 'pinsDone', pins });
                break;
        }
    } catch(err) {
        self.postMessage({ task: 'error', error: err.message });
    }
};
`;

const blob = new Blob([workerCode], { type: 'application/javascript' });
const worker = new Worker(URL.createObjectURL(blob));

worker.onmessage = function(e) {
    switch(e.data.task) {
        case 'pinsDone':
            STATE.pins = e.data.pins;
            processImage();
            break;
        case 'error':
            showAlert(e.data.error, 'danger');
            break;
    }
};

// بدء المعالجة
function processImage() {
    updateProgress(0);
    const img = document.getElementById('imageSrc');
    const canvas = document.getElementById('canvasOutput');
    const ctx = canvas.getContext('2d');
    
    canvas.width = STATE.IMG_SIZE;
    canvas.height = STATE.IMG_SIZE;
    
    img.onload = function() {
        ctx.drawImage(img, 0, 0, STATE.IMG_SIZE, STATE.IMG_SIZE);
        updateProgress(30);
        startCalculation();
    };
}

function startCalculation() {
    worker.postMessage({
        task: 'calculatePins',
        data: {
            total: parseInt(document.getElementById('numberOfPins').value),
            center: STATE.IMG_SIZE/2,
            radius: STATE.IMG_SIZE/2 - 1
        }
    });
}

// التهيئة النهائية
document.addEventListener('DOMContentLoaded', () => {
    document.querySelector('.progress').classList.remove('hidden');
});
</script>

<!-- التبعيات -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script async src="https://docs.opencv.org/master/opencv.js" onload="console.log('OpenCV loaded')"></script>
</body>
</html>
